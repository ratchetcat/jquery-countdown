// Generated by CoffeeScript 1.3.3

/*
Countdown

This plugin continuously measures the milliseconds between the current Date ( according to the browser ) and
a given future Date specified in the elements on which the plugin is initialized.

The interval at which this measurement occurs is configurable. The default interval is 5000ms ( 5 seconds ).
Note that the interval time will vary somewhat depending on the browser executing the code.

Each time the measurement is taken, the plugin will emit one of two events for each element being measured:
  countdown.update - The given future Date is still in the future.
  countdown.end    - The given future Date is equal to the current Date ( or equal to past Dates ).

Additionally, the plugin accepts two callbacks on initialization:
  onUpdate( el, remainingMilliseconds ) - Executed when the given future Date is still in the future.
  onEnd( el, remainingMilliseconds )    - Executed when the given future Date is equal to the current Date
                                          ( or equal to past Dates )

Note that each callback receives both a reference to the element in which a future Date is specified, and the number
of remaining milliseconds.

Usage:
  You should have one or more elements in which a valid ISO8601 Date is specified, like so:

  <p>Sun Mar 24 2013 11:43:28 GMT-0400 (EDT)</p>

  You may initialize this plugin on those elements using the following jQuery:
  $('p').countdown();

  To bind to events on those elements:

  $('p').bind("countdown.update", function() { $(this).css("background-color", "#ffc" ); });
  $('p').bind("countdown.end", function() { $(this).css("background-color", "#f66" ); });

  To initialize with custom callbacks and a custom interval:
  $('p').countdown({
    onUpdate: function( el, remainingMilliseconds ) { el.css("background-color", "#ffc"); },
    onEnd: function( el, remainingMilliseconds ) { el.css("background-color", "#f66"); },
    interval: 10000
  });

License:

This plugin is released under the MIT license.
*/


(function() {
  var $;

  $ = jQuery;

  $.fn.extend({
    countdown: function(options) {
      var defaults, millisecondsToEnd, settings;
      defaults = {
        eventPrefix: 'countdown.',
        interval: 5000,
        onEnd: function(el, remainingMilliseconds) {},
        onUpdate: function(el, remainingMilliseconds) {}
      };
      settings = $.extend(defaults, options);
      millisecondsToEnd = function(date, options) {
        if (!(date instanceof Date)) {
          return 0;
        }
        return new Date().getTime() - date;
      };
      return this.each(function() {
        var el, text, update;
        el = $(this);
        text = el.text();
        update = function() {
          var remainingMilliseconds;
          remainingMilliseconds = millisecondsToEnd(new Date(text));
          if ((Math.abs(remainingMilliseconds) < settings.interval) || (remainingMilliseconds > 0)) {
            el.trigger(settings.eventPrefix + "end", el);
            return settings.onEnd(el, remainingMilliseconds);
          } else {
            el.trigger(settings.eventPrefix + "update", el);
            settings.onUpdate(el, remainingMilliseconds);
            return setTimeout(function() {
              return update();
            }, settings.interval);
          }
        };
        return update();
      });
    }
  });

}).call(this);
